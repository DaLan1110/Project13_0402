<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>會員中心</title>
    <link rel="stylesheet" href="./css/bootstrap.min.css">
    <link rel="stylesheet" href="./css/all.min.css">
    <!-- s01 -->
    <link rel="stylesheet" href="./css/project_index_s01.css">
    <!-- s02 -->
    <link rel="stylesheet" href="./css/project_index_s02.css">
    <!-- s03 -->
    <link rel="stylesheet" href="./css/project_MemberCenter_s03.css">
    <!-- s04 -->
    <link rel="stylesheet" href="./css/project_MemberCenter_s04.css">
    <link rel="stylesheet" href="./css/myall.css">
</head>

<body>
    <!-- section01 會員-->
    <section>
        <nav class="navbar navbar-expand-lg bg-white p-0">
            <div class="container-fluid">
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                    aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse d-flex justify-content-end" id="navbarSupportedContent">
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link fw-700" aria-current="page" href="#" data-bs-toggle="modal"
                                data-bs-target="#registerModal" id="regmodal"><i
                                    class="fa-solid fa-user p-1"></i>加入會員</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link fw-700" href="#" data-bs-toggle="modal" data-bs-target="#loginModal"
                                id="loginmodal"><i class="fa-solid fa-pen p-1"></i>會員登入</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link fw-700 d-none" href="../../2024/project13/project_bg_index.html" id="backstage_btn"><i
                                    class="fa-solid fa-gear p-1"></i>後臺管理</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link fw-700" href="#"><i class="fa-solid fa-cart-shopping p-1"></i>購物車</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link fw-700 d-none" href="#" id="user_message"></a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle d-none" href="#" role="button" data-bs-toggle="dropdown"
                                aria-expanded="false" id="member_center">
                                <i class="fa-solid fa-circle-user" style="font-size: 25px;"></i>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-start">
                                <li><a class="dropdown-item"
                                        href="../../2024/project13/project_MemberCenter_Read.html">會員中心</a>
                                </li>
                                <li>
                                    <hr class="dropdown-divider">
                                </li>
                                <li><a class="dropdown-item" href="#" id="logout_btn">登出</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </section>

    <!-- section02 選單-->
    <section>
        <nav class="navbar navbar-expand-lg p-0 nav_border">
            <div class="container-fluid">
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                    aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse d-flex justify-content-center" id="navbarSupportedContent">
                    <ul class="navbar-nav">
                        <li class="nav-item mx-3">
                            <a class="nav-link fw-700" aria-current="page"
                                href="../../2024/project13/project_index.html">首頁</a>
                        </li>
                        <li class="nav-item mx-3">
                            <a class="nav-link fw-700" href="#" target="_blank">關於我們</a>
                        </li>
                        <li class="nav-item mx-3">
                            <a class="nav-link fw-700" href="#" target="_blank">最新消息</a>
                        </li>
                        <li class="nav-item mx-3">
                            <a class="nav-link fw-700" href="#" target="_blank">商品專區</a>
                        </li>
                        <li class="nav-item mx-3">
                            <a class="nav-link fw-700" href="#" target="_blank">聯絡我們</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </section>

    <!-- seciotn03-title 標語標題 -->
    <section>
        <div class="container">
            <div class="row text-center mt-5">
                <div class="col-12 mt-3">
                    <h1 class="fw-700 mb-0 s03_h1_font01">會員中心</h1>
                </div>
                <div class="col-12">
                    <hr class="mt-0 s03_hr">
                    </hr>
                </div>
            </div>
        </div>
    </section>

    <!-- section04 會員中心 -->
    <div class="container mt-3">
        <div class="row">
            <div class="col-2">
                <div class="list-group text-center">
                    <a href="#" class="list-group-item list-group-item-action active fw-700" aria-current="true">
                        會員資料
                    </a>
                    <a href="#" class="list-group-item list-group-item-action">會員訂單</a>
                    <a href="#" class="list-group-item list-group-item-action">會員預約</a>
                </div>
            </div>

            <div class="col-10 table-row justify-content-center">
                <div class="row text-center ">
                    <h3>會員資料</h3>
                </div>
                <div class="row mt-4 table_css" id="mydata">
                    <table class="text-center px-5 table-bordered table-striped table-hover table-sm">
                        <tr>
                            <th class="m-5" style="width: 25%;">大頭照</th>
                            <td><i class="fa-solid fa-circle-user fa-10x"></i></td>
                        </tr>
                        <tr>
                            <th>會員帳號</th>
                            <td>會員帳號!</td>
                        </tr>
                        <tr>
                            <th>會員等級</th>
                            <td>會員等級!</td>
                        </tr>
                        <tr>
                            <th>會員姓名</th>
                            <td>會員姓名!</td>
                        </tr>
                        <tr>
                            <th>會員暱稱</th>
                            <td>會員暱稱!</td>
                        </tr>
                        <tr>
                            <th>會員性別</th>
                            <td>會員性別!</td>
                        </tr>
                        <tr>
                            <th>聯絡電話</th>
                            <td>聯絡電話!</td>
                        </tr>
                        <tr>
                            <th>電子郵件</th>
                            <td>電子郵件!</td>
                        </tr>
                        <tr>
                            <th>生日</th>
                            <td>生日!</td>
                        </tr>
                        <tr>
                            <th>地址</th>
                            <td>地址!</td>
                        </tr>
                        <tr>
                            <th colspan="2"><button class="btn btn-dark" id="update_btn" data-bs-toggle="modal"
                                    data-bs-target="#UpdateModal" data-id="xx" data-photo="xx" data-username="xx"
                                    data-nickname="xx" data-gender="xx" data-mobile="xx" data-email="xx"
                                    data-birthday="xx" data-address="xx">編輯</button></th>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- section04 MemberUpdateModal 編輯會員 -->
    <div class="modal fade" id="UpdateModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-md">
            <div class="modal-content">
                <div class="modal-header text-bg-dark">
                    <h1 class="modal-title fs-5 text-center" id="exampleModalLabel">編輯會員</h1>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="timeline-section02">
                        <div class="row">
                            <div class="mb-2">
                                <label for="update_photo" class="form-label">大頭照 :</label>
                                <input type="file" class="form-control" placeholder="" id="update_photo"
                                    name="update_photo">
                                <div class="valid-feedback" id="update_photo_ok"></div>
                                <div class="invalid-feedback" id="update_photo_no"></div>
                            </div>
                            <div class="mb-2">
                                <label for="update_username" class="form-label">會員姓名 :</label>
                                <input type="text" class="form-control" placeholder="" id="update_username"
                                    name="update_username">
                                <div class="valid-feedback">名稱可以</div>
                                <div class="invalid-feedback">名稱不得低於一個字</div>
                            </div>
                            <div class="mb-2">
                                <label for="update_nickname" class="form-label">會員暱稱 :</label>
                                <input type="text" class="form-control" placeholder="" id="update_nickname"
                                    name="update_nickname">
                                <div class="valid-feedback">暱稱可以</div>
                                <div class="invalid-feedback">暱稱不得低於一個字</div>
                            </div>
                            <div class="mb-2">
                                <label for="update_gender" class="form-label">會員性別</label>
                                <div></div>
                                <div class="form-check form-check-inline">
                                    <input type="radio" class="form-check-input" name="rad" id="radio_male" value="男性"
                                        checked>
                                    <label for="radio_male" class="form-check-label">男性</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input type="radio" class="form-check-input" name="rad" id="radio_female"
                                        value="女性">
                                    <label for="radio_female" class="form-check-label">女性</label>
                                </div>
                            </div>
                            <div class="mb-2">
                                <label for="update_mobile" class="form-label">連絡電話 :</label>
                                <input type="text" class="form-control" placeholder="" id="update_mobile"
                                    name="update_mobile">
                                <div class="valid-feedback">字數符合</div>
                                <div class="invalid-feedback">低於或超過10個字</div>
                            </div>
                            <div class="mb-2">
                                <label for="update_email" class="form-label">電子郵件 :</label>
                                <input type="text" class="form-control" placeholder="" id="update_email"
                                    name="update_email">
                                <div class="valid-feedback">符合</div>
                                <div class="invalid-feedback">不符合</div>
                            </div>
                            <div class="mb-2">
                                <label for="update_birthday" class="form-label">生日 :</label>
                                <input type="text" class="form-control" placeholder="" id="update_birthday"
                                    name="update_birthday">
                                <div class="valid-feedback"></div>
                                <div class="invalid-feedback"></div>
                            </div>
                            <div class="mb-2">
                                <label for="update_address" class="form-label">地址 :</label>
                                <input type="text" class="form-control" placeholder="" id="update_address"
                                    name="update_address">
                                <div class="valid-feedback"></div>
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-outline-dark" id="modal_update_btn">更新</button>
                    </div>
                </div>


            </div>
        </div>
    </div>
    <script src="./js/bootstrap.bundle.min.js"></script>
    <script src="./js/jquery-3.7.1.min.js"></script>
    <script>
        var u_id;
        var gender;
        var radArray = [];

        var flag_username = true;
        var flag_nickname = true;
        var flag_gender = true;
        var flag_mobile = true;
        var flag_email = true;
        var flag_birthday = true;
        var flag_address = true;

        $(function () {
            if (getCookie != "UID01") {
                // 判斷是否登入 UID01存在, 傳遞至後端api 判斷是否合法
                var dataJSON = {};
                dataJSON["UID01"] = getCookie("UID01");
                console.log(JSON.stringify(dataJSON));

                $.ajax({
                    type: "POST",
                    url: "../../2024/project13/project_Member_CheckUID_api.php",
                    data: JSON.stringify(dataJSON),
                    dataType: "json",
                    success: showdata_Check_UID,
                    error: function () {
                        alert("error-../../2024/project13/project_Member_CheckUID_api.php");
                    }
                });

                // 讀取會員資料
                $.ajax({
                    type: "POST",
                    url: "../../2024/project13/project_MemberCenter_Read_api.php",
                    data: JSON.stringify(dataJSON),
                    dataType: "json",
                    // 關閉同步，先讓資料讀取
                    async: false,
                    success: showdata,
                    error: function () {
                        alert("error-../../2024/project13/project_MemberCenter_Read_api.php");
                    }
                });


            } else {
                location.href = "../../2024/project13/project_index.html";
            }

            // 編輯及更新 #update_btn
            $("body").on("click", "#mydata #update_btn", function () {
                console.log("update_btn_ok");
                console.log($(this).data("id"));
                console.log($(this).data("username"));
                console.log($(this).data("nickname"));
                console.log($(this).data("mobile"));
                console.log($(this).data("email"));
                console.log($(this).data("birthday"));
                console.log($(this).data("address"));
                console.log($(this).data("gender"));


                u_id = $(this).data("id");
                $("#update_username").val($(this).data("username"));
                $("#update_nickname").val($(this).data("nickname"));
                // $("#update_gender").val($(this).data("gender"));
                radArray = $(this).data("gender").split(", ");
                console.log(radArray);
                $("#update_mobile").val($(this).data("mobile"));
                $("#update_email").val($(this).data("email"));
                $("#update_birthday").val($(this).data("birthday"));
                $("#update_address").val($(this).data("address"));

                // 檢查性別 監聽 radio #rad
                console.log(radArray.length);
                $("#radio_male").prop('checked', false);
                $("#radio_female").prop('checked', false);
                for (var i = 0; i < radArray.length; i++) {
                    if (radArray[i] == "男性") {
                        $("#radio_male").prop('checked', true);
                        flag_gender = true;
                    } else if (radArray[i] == "女性") {
                        $("#radio_female").prop('checked', true);
                        flag_gender = true;
                    }

                };

                // Modal更新鍵 #modal_update_btn
                $("#modal_update_btn").click(function () {
                    if ($("#update_username").val() != 0 && $("#update_nickname").val() != 0 && $("#update_mobile").val() != 0 && $("#update_email").val() != 0 && $("#update_address").val() != 0) {
                        var red_gender = [];
                        $.each($("input[name='rad']:checked"), function () {
                            red_gender = $(this).val();
                        });
                        console.log(red_gender);
                        if (red_gender.length != 0) {
                            if (flag_username == true && flag_nickname == true && flag_mobile == true && flag_email == true && flag_address == true) {

                                // 產生json格式的參數
                                var dataJSON = {};
                                dataJSON["ID"] = u_id;
                                dataJSON["UserName"] = $("#update_username").val();
                                dataJSON["NickName"] = $("#update_nickname").val();
                                dataJSON["Gender"] = red_gender;
                                dataJSON["Mobile"] = $("#update_mobile").val();
                                dataJSON["Email"] = $("#update_email").val();
                                dataJSON["Birthday"] = $("#update_birthday").val();
                                dataJSON["Address"] = $("#update_address").val();
                                console.log(JSON.stringify(dataJSON));

                                // 傳遞更新參數至後端api
                                $.ajax({
                                    type: "POST",
                                    url: "../../2024/project13/project_MemberCenter_Update_api.php",
                                    data: JSON.stringify(dataJSON),
                                    dataType: "json",
                                    success: showdata_update,
                                    error: function () {
                                        alert("Error-../../2024/project13/project_MemberCenter_Update_api.php");
                                    }
                                });

                            } else {
                                alert("資料欄位填寫格式有誤!!");
                            }
                        } else {
                            alert("資料欄位填寫格式有誤!!!");
                        }
                    }else{
                        alert("資料欄位不得留白!!");
                    }
                });
            });

            // 登出
            $(function () {
                $("#logout_btn").click(function () {
                    if (confirm("確定是否登出？")) {
                        console.log("logout_ok_btn");
                        // 更改UID01為""
                        setCookie("UID01", "", 7);
                        // 需使用套件，刪除UID01值
                        // $.removeCookie('UID01', { path: '/' });
                        alert("登出成功");
                        location.href = "../../2024/project13/project_index.html";
                    }
                });
            });

            // 檢查名字
            $('#update_username').bind("input propertychange", function () {
                console.log($(this).val().length);
                if ($(this).val().length > 1 && $(this).val().length < 11) {
                    console.log("ok");
                    // 字數符合規定
                    $(this).removeClass("is-valid");
                    $(this).removeClass("is-invalid");
                    $(this).addClass("is-valid");
                    flag_username = true;
                } else {
                    // 字數不符合規定
                    $(this).removeClass("is-valid");
                    $(this).removeClass("is-invalid");
                    $(this).addClass("is-invalid");
                    flag_username = false;
                }
            });

            // 檢查暱稱
            $('#update_nickname').bind("input propertychange", function () {
                console.log($(this).val().length);
                if ($(this).val().length > 1 && $(this).val().length < 11) {
                    console.log("ok");
                    // 字數符合規定
                    $(this).removeClass("is-valid");
                    $(this).removeClass("is-invalid");
                    $(this).addClass("is-valid");
                    flag_nickname = true;
                } else {
                    // 字數不符合規定
                    $(this).removeClass("is-valid");
                    $(this).removeClass("is-invalid");
                    $(this).addClass("is-invalid");
                    flag_nickname = false;
                }
            });

            // 檢查手機
            $('#update_mobile').bind("input propertychange", function () {
                console.log($(this).val().length);
                if ($(this).val().length == 10) {
                    console.log("ok");
                    // 字數符合規定
                    $(this).removeClass("is-valid");
                    $(this).removeClass("is-invalid");
                    $(this).addClass("is-valid");
                    flag_mobile = true;
                } else {
                    // 字數不符合規定
                    $(this).removeClass("is-valid");
                    $(this).removeClass("is-invalid");
                    $(this).addClass("is-invalid");
                    flag_mobile = false;
                }
            });

            // 檢查電子郵件
            $('#update_email').bind("input propertychange", function () {
                console.log($(this).val().length);
                if ($(this).val().length > 5 && $(this).val().length < 64) {
                    console.log("ok");
                    // 字數符合規定
                    $(this).removeClass("is-valid");
                    $(this).removeClass("is-invalid");
                    $(this).addClass("is-valid");
                    flag_email = true;
                } else {
                    // 字數不符合規定
                    $(this).removeClass("is-valid");
                    $(this).removeClass("is-invalid");
                    $(this).addClass("is-invalid");
                    flag_email = false;
                }
            });

            // 檢查地址
            $('#update_address').bind("input propertychange", function () {
                console.log($(this).val().length);
                if ($(this).val().length > 5 && $(this).val().length < 32) {
                    console.log("ok");
                    // 字數符合規定
                    $(this).removeClass("is-valid");
                    $(this).removeClass("is-invalid");
                    $(this).addClass("is-valid");
                    flag_address = true;
                } else {
                    // 字數不符合規定
                    $(this).removeClass("is-valid");
                    $(this).removeClass("is-invalid");
                    $(this).addClass("is-invalid");
                    flag_address = false;
                }
            });

        });

        // 讀取會員資料
        function showdata(data) {
            console.log(data);
            var item = data.data[0];
            console.log(item);
            // 將 null 值轉換為空白字串
            for (var key in item) {
                if (item[key] == null) {
                    item[key] = '';
                }

                if (item[key] == "100") {
                    item[key] = '一般會員';
                }

                if (item[key] == "90") {
                    item[key] = 'VIP會員';
                }

                if (item[key] == "1") {
                    item[key] = '管理員';
                }
            }

            $("#mydata").empty();
            var strHTML = '<table class="text-center px-5 table-bordered table-striped table-hover table-sm">' +
                '<tr>' +
                '<th style="width: 25%;">大頭照</th>' +
                '<td>' + item.Photo + '</td>' +
                '</tr>' +
                '<tr>' +
                '<th>會員帳號</th>' +
                '<td>' + item.Account + '</td>' +
                '</tr>' +
                '<tr>' +
                '<th>會員等級</th>' +
                '<td>' + item.Level + '</td>' +
                '</tr>' +
                '<tr>' +
                '<th>會員姓名</th>' +
                '<td>' + item.UserName + '</td>' +
                '</tr>' +
                '<tr>' +
                '<th>會員暱稱</th>' +
                '<td>' + item.NickName + '</td>' +
                '</tr>' +
                '<tr>' +
                '<th>會員性別</th>' +
                '<td>' + item.Gender + '</td>' +
                '</tr>' +
                '<tr>' +
                '<th>聯絡電話</th>' +
                '<td>' + item.Mobile + '</td>' +
                '</tr>' +
                '<tr>' +
                '<th>電子郵件</th>' +
                '<td>' + item.Email + '</td>' +
                '</tr>' +
                '<tr>' +
                '<th>生日</th>' +
                '<td>' + item.Birthday + '</td>' +
                '</tr>' +
                '<tr>' +
                '<th>地址</th>' +
                '<td>' + item.Address + '</td>' +
                '</tr>' +
                '<tr>' +
                '<th colspan="2"><button class="btn btn-dark" id="update_btn" data-bs-toggle="modal" data-bs-target="#UpdateModal" data-id="' + item.ID + '" data-photo="' + item.Photo + '" data-username="' + item.UserName + '" data-nickname="' + item.NickName + '" data-gender="' + item.Gender + '" data-mobile="' + item.Mobile + '" data-email="' + item.Email + '" data-birthday="' + item.Birthday + '" data-address="' + item.Address + '">編輯</button></th>' +
                '</tr>' +
                '</table>';
            $("#mydata").append(strHTML);
        }

        // 更新會員資料
        function showdata_update(data) {
            console.log(data);
            if (data.state) {
                alert(data.message);
                location.href = "../../2024/project13/project_MemberCenter_Read.html";
            } else {
                alert(data.message);
            }
        }

        // 檢查UID 是否可保持繼續登入
        function showdata_Check_UID(data) {
            console.log(data);
            if (data.state) {
                console.log(data.data[0].UID01);
                // 驗證成功
                // 隱藏註冊/登入鍵
                $("#loginmodal").hide();
                $("#regmodal").hide();
                // 顯示會員中心
                $("#user_message").removeClass("d-none");
                $("#user_message").addClass("ms-3");
                $("#user_message").text(data.data[0].UserName + " 早安~!!");
                $("#member_center").removeClass("d-none");
                if (data.data[0].Level == 1) {
                    // console.log("permission_ok");
                    $("#backstage_btn").removeClass("d-none");
                }
            } else {
                // 驗證失敗，返回首頁
                location.href = "../../2024/project13/project_index.html";
            }
        }

        // w3s setCookie
        function setCookie(cname, cvalue, exdays) {
            const d = new Date();
            d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
            let expires = "expires=" + d.toUTCString();
            document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
        }

        // w3s getCookie
        function getCookie(cname) {
            let name = cname + "=";
            let decodedCookie = decodeURIComponent(document.cookie);
            let ca = decodedCookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) == ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                    return c.substring(name.length, c.length);
                }
            }
            return "";
        }
    </script>

</body>

</html>